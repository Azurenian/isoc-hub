<!-- Hub-OJT Section Scripts -->
<script>
  // OJT-specific variables
  let ojtSpreadsheetData = [];
  let ojtSelectedCardIndex = undefined;
  let ojtPendingDeleteIndex = null;

  // OJT Modal instances
  let ojtModal = null;
  let ojtDeleteConfirmModal = null;
  let ojtCommentModal = null;
  let ojtViewCommentsModal = null;

  document.addEventListener("DOMContentLoaded", function () {
    // Initialize OJT modals
    ojtModal = new bootstrap.Modal(document.getElementById("ojtModal"));
    ojtDeleteConfirmModal = new bootstrap.Modal(
      document.getElementById("ojtDeleteConfirmModal")
    );
    ojtCommentModal = new bootstrap.Modal(document.getElementById("ojtCommentModal"));
    ojtViewCommentsModal = new bootstrap.Modal(
      document.getElementById("ojtViewCommentsModal")
    );

    // OJT Add Button
    document
      .querySelector('#hub-ojt-section .btn-success[title="Add OJT Project"]')
      .addEventListener("click", function () {
        document.getElementById("ojtModalLabel").textContent = "Add OJT Project";
        document.getElementById("ojtForm").reset();
        document.getElementById("ojtEditIndex").value = "";
        ojtModal.show();
      });

    // OJT Edit Button
    document
      .querySelector('#hub-ojt-section .btn-warning[title="Edit"]')
      .addEventListener("click", function () {
        const index = ojtSelectedCardIndex;
        if (index === undefined) {
          showOjtNotification("Please select an OJT project to edit.", "#ffc107");
          return;
        }
        const project = ojtSpreadsheetData[index];
        document.getElementById("ojtName").value = project.name;
        document.getElementById("ojtLink").value = project.link;
        document.getElementById("ojtDescription").value = project.description;
        document.getElementById("ojtEditIndex").value = index;
        document.getElementById("ojtModalLabel").textContent = "Edit OJT Project";
        ojtModal.show();
      });

    // OJT Delete Button
    document
      .querySelector('#hub-ojt-section .btn-danger[title="Delete"]')
      .addEventListener("click", function () {
        const index = ojtSelectedCardIndex;
        if (index === undefined) {
          showOjtNotification("Please select an OJT project to delete.", "#dc3545");
          return;
        }
        ojtPendingDeleteIndex = index;
        ojtDeleteConfirmModal.show();
      });

    // OJT Confirm Delete
    document.getElementById("ojtConfirmDeleteBtn").onclick = function () {
      if (ojtPendingDeleteIndex !== null) {
        google.script.run
          .withSuccessHandler(function () {
            showOjtNotification("OJT Project deleted successfully!");
            ojtSelectedCardIndex = undefined;
            loadOjtProjects();
          })
          .withFailureHandler(function (err) {
            showOjtNotification("Failed to delete: " + err.message, "#dc3545");
          })
          .deleteOjtProjectFromSheet(ojtPendingDeleteIndex);
        ojtPendingDeleteIndex = null;
        ojtDeleteConfirmModal.hide();
      }
    };

    // OJT Refresh Button
    document
      .querySelector('#hub-ojt-section .btn-info[title="Refresh"]')
      .addEventListener("click", function () {
        ojtSelectedCardIndex = undefined;
        loadOjtProjects();
      });

    // Handle OJT form submit for Add/Edit
    document.getElementById("ojtForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const name = document.getElementById("ojtName").value.trim();
      const link = document.getElementById("ojtLink").value.trim();
      const description = document.getElementById("ojtDescription").value.trim();
      const editIndex = document.getElementById("ojtEditIndex").value;

      if (editIndex === "") {
        // Add mode
        google.script.run
          .withSuccessHandler(function () {
            showOjtNotification("OJT Project added successfully!");
            const newProject = { name, link, description };
            ojtSpreadsheetData.push(newProject);
            ojtSelectedCardIndex = undefined;
            renderOjtCards(ojtSpreadsheetData);
          })
          .withFailureHandler(function (err) {
            showOjtNotification("Failed to add: " + err.message, "#dc3545");
          })
          .addOjtProjectToSheet(name, link, description);
      } else {
        // Edit mode
        google.script.run
          .withSuccessHandler(function () {
            ojtSpreadsheetData[editIndex] = { name, link, description };
            ojtSelectedCardIndex = undefined;
            renderOjtCards(ojtSpreadsheetData);
            showOjtNotification("OJT Project updated successfully!");
          })
          .withFailureHandler(function (err) {
            showOjtNotification("Failed to update: " + err.message, "#dc3545");
          })
          .editOjtProjectInSheet(editIndex, name, link, description);
      }
      ojtModal.hide();
    });

    // Handle OJT comment form submit
    document.getElementById("ojtCommentForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const name = document.getElementById("ojtCommentName").value.trim();
      const comment = document.getElementById("ojtCommentText").value.trim();
      const cardId = document.getElementById("ojtCommentCardId").value;

      if (!name || !comment) {
        showOjtNotification("Please enter your name and comment.", "#dc3545");
        return;
      }

      ojtCommentModal.hide();
      google.script.run
        .withSuccessHandler(function () {
          showOjtNotification("Comment submitted!");
        })
        .withFailureHandler(function (err) {
          showOjtNotification("Failed to submit comment: " + err.message, "#dc3545");
        })
        .addOjtCommentToSheet(name, comment, cardId);
    });

    // OJT Search functionality
    const ojtSearchInput = document.getElementById("hubOjtSearchInput");
    const ojtSuggestions = document.getElementById("hubOjtSearchSuggestions");
    
    ojtSearchInput.addEventListener("input", function () {
      const query = this.value.trim();
      
      if (!query) {
        ojtSuggestions.style.display = "none";
        renderOjtCards(ojtSpreadsheetData);
        return;
      }

      // Get suggestions from Google Sheets for OJT
      google.script.run
        .withSuccessHandler(function(suggestionsData) {
          if (suggestionsData && suggestionsData.length > 0) {
            const uniqueSuggestions = suggestionsData
              .filter((item, index, self) => 
                index === self.findIndex(t => t.name === item.name)
              )
              .slice(0, 5);

            ojtSuggestions.innerHTML = uniqueSuggestions
              .map(rec => `
                <li class="list-group-item list-group-item-action d-flex justify-content-between align-items-start" 
                    style="cursor: pointer; border-bottom: 1px solid #e9ecef;" 
                    data-name="${rec.name}" 
                    data-link="${rec.link}"
                    data-id="${rec.id}"
                    data-type="${rec.matchType}">
                  <div>
                    <div class="fw-medium" style="font-size: 0.95rem;">
                      ${rec.matchType === 'id' ? `ID: ${rec.id}` : 
                        rec.matchType === 'link' ? `Link: ${rec.link}` : 
                        rec.name}
                    </div>
                    <small class="text-muted">${rec.name}</small>
                  </div>
                  <span class="badge bg-${rec.matchType === 'id' ? 'primary' : rec.matchType === 'link' ? 'success' : 'secondary'} rounded-pill" style="font-size: 0.7rem;">
                    ${rec.matchType.toUpperCase()}
                  </span>
                </li>
              `).join("");
            ojtSuggestions.style.display = "block";
          } else {
            ojtSuggestions.innerHTML = `
              <li class="list-group-item text-muted text-center" style="font-style: italic;">
                No recommendations found
              </li>
            `;
            ojtSuggestions.style.display = "block";
          }
        })
        .withFailureHandler(function(error) {
          console.error("Error getting OJT suggestions:", error);
        })
        .getOjtSearchSuggestions(query);

      // Filter locally for immediate feedback
      const localFiltered = ojtSpreadsheetData.filter(project => {
        const name = (project.name || '').toLowerCase();
        const link = (project.link || '').toLowerCase();
        const description = (project.description || '').toLowerCase();
        const id = (project.id || '').toLowerCase();
        
        return name.includes(query.toLowerCase()) || 
               link.includes(query.toLowerCase()) || 
               description.includes(query.toLowerCase()) || 
               id.includes(query.toLowerCase());
      });
      renderOjtCards(localFiltered);
    });

    // Handle Enter key for OJT search
    ojtSearchInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        const query = this.value.trim();
        
        if (!query) {
          renderOjtCards(ojtSpreadsheetData);
          ojtSuggestions.style.display = "none";
          return;
        }

        google.script.run
          .withSuccessHandler(function(results) {
            if (results && results.length > 0) {
              renderOjtCards(results);
              showOjtNotification(`Found ${results.length} result(s)`, "#28a745");
            } else {
              renderOjtCards([]);
              const container = document.querySelector(".ojt-card-container");
              container.innerHTML = `
                <div class="col-12">
                  <div class="alert alert-warning text-center" role="alert">
                    <i class="bi bi-search"></i>
                    <h5 class="mt-2">No results found</h5>
                    <p class="mb-0">No OJT projects match: "${query}"</p>
                  </div>
                </div>
              `;
              showOjtNotification("No results found", "#ffc107");
            }
          })
          .withFailureHandler(function(error) {
            console.error("OJT Search error:", error);
            showOjtNotification("Search error", "#dc3545");
          })
          .filterOjtProjectsBySearch(query);
        
        ojtSuggestions.style.display = "none";
      }
    });

    // Handle OJT suggestion clicks
    ojtSuggestions.addEventListener("click", function (e) {
      const listItem = e.target.closest("li.list-group-item-action");
      if (listItem) {
        const name = listItem.getAttribute("data-name");
        const link = listItem.getAttribute("data-link");
        const id = listItem.getAttribute("data-id");
        const type = listItem.getAttribute("data-type");
        
        if (type === 'id') {
          ojtSearchInput.value = id;
        } else if (type === 'link') {
          ojtSearchInput.value = link;
        } else {
          ojtSearchInput.value = name;
        }
        
        google.script.run
          .withSuccessHandler(function(filteredData) {
            if (filteredData && filteredData.length > 0) {
              renderOjtCards(filteredData);
              showOjtNotification(`Found ${filteredData.length} result(s)`, "#28a745");
            } else {
              renderOjtCards([]);
              showOjtNotification("No results found", "#ffc107");
            }
          })
          .withFailureHandler(function(error) {
            console.error("OJT Filter error:", error);
            showOjtNotification("Filter error", "#dc3545");
          })
          .filterOjtProjectsBySearch(ojtSearchInput.value);
        
        ojtSuggestions.style.display = "none";
      }
    });

    // Handle OJT search focus/blur
    ojtSearchInput.addEventListener("blur", function () {
      setTimeout(() => {
        ojtSuggestions.style.display = "none";
      }, 200);
    });

    ojtSearchInput.addEventListener("focus", function () {
      if (ojtSuggestions.innerHTML.trim() !== "" && this.value.trim() !== "") {
        ojtSuggestions.style.display = "block";
      }
    });

    // Load OJT projects on page load
    loadOjtProjects();
  });

  // OJT View comments functionality
  document.getElementById("ojtSeeRecentCommentBtn").onclick = function () {
    const cardId = document.getElementById("ojtCommentCardId").value;
    ojtViewCommentsModal.show();
    const container = document.getElementById("ojtViewCommentsBody");
    container.style.opacity = 0;
    container.style.transform = "translateY(16px)";
    container.innerHTML = `<div class="text-muted">Loading comments...</div>`;
    
    google.script.run
      .withSuccessHandler(function (comments) {
        if (comments && comments.length > 0) {
          container.innerHTML = comments
            .map(comment => `
              <div class="border rounded p-2 bg-light mb-2">
                <div class="fw-semibold" style="font-size:0.97em;">${comment.name}</div>
                <div style="font-size:0.98em;">${comment.comment}</div>
                <div class="text-muted" style="font-size:0.85em;">${comment.date || ""}</div>
              </div>
            `).join("");
        } else {
          container.innerHTML = `<div class="text-muted">No comments yet.</div>`;
        }
        setTimeout(() => {
          container.style.opacity = 1;
          container.style.transform = "translateY(0)";
        }, 10);
      })
      .getOjtCommentsForCard(cardId);
  };

  // Render OJT cards function
  function renderOjtCards(data) {
    const container = document.querySelector(".ojt-card-container");
    container.innerHTML = "";
    data.forEach((project, index) => {
      const card = document.createElement("div");
      card.className = "col-md-4 mb-3";
      card.setAttribute("data-index", index);
      card.innerHTML = `
        <div class="card h-100 shadow-sm border-0" data-index="${index}">
          <div class="card-body d-flex flex-column position-relative">
            <input type="checkbox" class="form-check-input select-ojt-card-checkbox position-absolute top-0 end-0 mt-3 me-3" data-index="${index}" style="width: 1.5em; height: 1.5em; border-radius: 50%; border: 2px solid #6366f1; box-shadow: 0 1px 4px rgba(0,0,0,0.07);" ${
        ojtSelectedCardIndex === index ? "checked" : ""
      }>
            <h5 class="card-title fw-semibold">${project.name}</h5>
            <p class="card-text flex-grow-1">${project.description}</p>
            <a href="${project.link}" target="_blank" rel="noopener noreferrer"
               class="ojt-btn ojt-btn-link mb-2">
              <i class="bi bi-box-arrow-up-right"></i>
              <span>Open Link</span>
            </a>
            <button type="button" class="ojt-btn ojt-btn-comment comment-ojt-card-btn" data-index="${index}" data-card-id="${project.name}">
              <i class="bi bi-chat-dots"></i>
              <span>Comment</span>
            </button>
          </div>
        </div>
      `;
      container.appendChild(card);
    });

    // Add checkbox event listeners
    document.querySelectorAll(".select-ojt-card-checkbox").forEach((checkbox) => {
      checkbox.onchange = function () {
        const index = parseInt(this.getAttribute("data-index"));
        if (this.checked) {
          document.querySelectorAll(".select-ojt-card-checkbox").forEach((cb) => {
            if (cb !== this) cb.checked = false;
          });
          ojtSelectedCardIndex = index;
          document.querySelectorAll(".card.h-100").forEach((c, i) => {
            c.classList.toggle("border-primary", i === index);
            c.classList.toggle("shadow", i === index);
          });
        } else {
          ojtSelectedCardIndex = undefined;
          document.querySelectorAll(".card.h-100").forEach((c) => {
            c.classList.remove("border-primary", "shadow");
          });
        }
      };
    });

    // Add comment button listeners
    document.querySelectorAll(".comment-ojt-card-btn").forEach((btn) => {
      btn.onclick = function () {
        const cardId = btn.getAttribute("data-card-id");
        document.getElementById("ojtCommentCardId").value = cardId;
        document.getElementById("ojtCommentForm").reset();
        document.getElementById("ojtRecentCommentResult").innerHTML = "";
        ojtCommentModal.show();
      };
    });

    container.style.opacity = 1;
    document.getElementById("ojt-loading-spinner").style.display = "none";
  }

  // Load OJT projects function
  function loadOjtProjects() {
    document.querySelector(".ojt-card-container").style.opacity = 0;
    document.getElementById("ojt-loading-spinner").style.display = "flex";
    google.script.run
      .withSuccessHandler(function (data) {
        ojtSpreadsheetData = data;
        renderOjtCards(ojtSpreadsheetData);
      })
      .withFailureHandler(function (err) {
        showOjtNotification("Failed to load OJT data: " + err.message, "#dc3545");
        document.getElementById("ojt-loading-spinner").style.display = "none";
      })
      .getOjtProjectsFromSheet();
  }

  // Show OJT notification function
  function showOjtNotification(message, color = "#198754") {
    const bar = document.getElementById("ojt-notification-bar");
    bar.textContent = message;
    bar.style.background = color;
    bar.style.display = "block";
    bar.style.opacity = 0;
    bar.style.top = "24px";
    setTimeout(() => {
      bar.style.opacity = 1;
      bar.style.top = "40px";
    }, 10);
    setTimeout(() => {
      bar.style.opacity = 0;
      bar.style.top = "24px";
      setTimeout(() => {
        bar.style.display = "none";
      }, 400);
    }, 2500);
  }
</script>