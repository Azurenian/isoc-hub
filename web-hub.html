<!--
  web-hub.html
  Purpose: Hub section container for the ISOC Hub application.
-->

<div id="hub-section" class="section active">
  <div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="fw-bold mb-0 hub-title">
        International Service Operations Center Hub
      </h3>
      <div class="btn-group" role="group" aria-label="Hub Controls">
        <button
          class="btn btn-success d-flex align-items-center me-2 shadow-sm"
          title="Add"
        >
          <span class="me-1 fs-5"><i class="bi bi-plus-circle"></i></span>
          <span>Add</span>
        </button>
        <button
          class="btn btn-warning d-flex align-items-center me-2 shadow-sm text-dark"
          title="Edit"
        >
          <span class="me-1 fs-5"><i class="bi bi-pencil-square"></i></span>
          <span>Edit</span>
        </button>
        <button
          class="btn btn-danger d-flex align-items-center me-2 shadow-sm"
          title="Delete"
        >
          <span class="me-1 fs-5"><i class="bi bi-trash"></i></span>
          <span>Delete</span>
        </button>
        <button
          class="btn btn-info d-flex align-items-center shadow-sm text-white"
          title="Refresh"
        >
          <span class="me-1 fs-5"><i class="bi bi-arrow-clockwise"></i></span>
          <span>Refresh</span>
        </button>
      </div>
    </div>
    <!-- Loading Spinner -->
    <div
      id="loading-spinner"
      style="
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100px;
      "
    >
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <!-- Cards Container -->
    <div class="container">
      <div
        class="row card-container"
        style="opacity: 0; transition: opacity 0.5s"
      ></div>
    </div>
  </div>
</div>

<!-- Modal for Add/Edit -->
<div
  class="modal fade"
  id="appModal"
  tabindex="-1"
  aria-labelledby="appModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <form id="appForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="appModalLabel">Add Web App</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editIndex" />
        <div class="mb-3">
          <label for="appName" class="form-label">Web App Name</label>
          <input type="text" class="form-control" id="appName" required />
        </div>
        <div class="mb-3">
          <label for="appLink" class="form-label">Link</label>
          <input type="url" class="form-control" id="appLink" required />
        </div>
        <div class="mb-3">
          <label for="appDescription" class="form-label">Description</label>
          <textarea
            class="form-control"
            id="appDescription"
            rows="3"
            required
          ></textarea>
        </div>
        <!-- Upload Photo Field -->
        <div class="mb-3">
          <label for="appPhoto" class="form-label">Upload Photo</label>
          <input
            type="file"
            class="form-control"
            id="appPhoto"
            accept="image/*"
          />
          <div class="mt-2 text-center">
            <img
              id="photoPreview"
              src=""
              alt="Preview"
              style="
                max-width: 120px;
                max-height: 120px;
                display: none;
                border-radius: 50%;
                object-fit: cover;
                border: 2px solid #e5e7eb;
              "
            />
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>
<style>
  #appModal:not(.show) {
    display: none;
  }

  /* Futuristic Button Styles */
  .btn-futuristic {
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    background: linear-gradient(
      135deg,
      rgba(30, 41, 59, 0.8),
      rgba(15, 23, 42, 0.9)
    );
    backdrop-filter: blur(8px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15),
      inset 0 1px 0 rgba(255, 255, 255, 0.08);
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    position: relative;
    overflow: hidden;
    padding: 12px 20px;
    font-weight: 500;
    letter-spacing: 0.4px;
  }

  .btn-futuristic:before {
    content: "";
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    z-index: -1;
    background: linear-gradient(45deg, #3b82f6, #10b981, #6366f1);
    border-radius: 13px;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .btn-futuristic:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
  }

  .btn-futuristic:hover:before {
    opacity: 1;
  }

  .btn-futuristic:active {
    transform: translateY(0);
  }

  /* Link button specific style */
  .btn-link-futuristic {
    color: #38bdf8;
  }

  .btn-link-futuristic:hover {
    color: #7dd3fc;
  }

  /* Select button specific style */
  .btn-select-futuristic {
    color: #34d399;
  }

  .btn-select-futuristic:hover {
    color: #6ee7b7;
  }

  /* Comment button specific style */
  .btn-comment-futuristic {
    color: #a78bfa;
  }

  .btn-comment-futuristic:hover {
    color: #c4b5fd;
  }

  /* Icon pulse animation */
  @keyframes iconPulse {
    0% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.1);
    }
    100% {
      transform: scale(1);
    }
  }

  .btn-futuristic i {
    display: inline-block;
    margin-right: 8px;
    transform: translateZ(0);
  }

  .btn-futuristic:hover i {
    animation: iconPulse 1s infinite ease-in-out;
  }

  /* Glow effect for selected state */
  .btn-futuristic.selected {
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5),
      0 0 15px rgba(99, 102, 241, 0.5);
  }

  /* Button ripple effect */
  .ripple {
    position: absolute;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: scale(0);
    animation: ripple 0.6s linear;
    pointer-events: none;
  }

  @keyframes ripple {
    to {
      transform: scale(4);
      opacity: 0;
    }
  }
</style>

<!-- Delete Confirmation Modal -->
<div
  class="modal fade"
  id="deleteConfirmModal"
  tabindex="-1"
  aria-labelledby="deleteConfirmLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteConfirmLabel">Confirm Deletion</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this card? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          No
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
          Yes, Delete
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Comment Modal -->
<div
  class="modal fade"
  id="commentModal"
  tabindex="-1"
  aria-labelledby="commentModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <form id="commentForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="commentModalLabel">Add Comment</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="commentCardId" />
        <div class="mb-3">
          <label for="commentName" class="form-label">Your Name</label>
          <input type="text" class="form-control" id="commentName" required />
        </div>
        <div class="mb-3">
          <label for="commentText" class="form-label">Comment</label>
          <textarea
            class="form-control"
            id="commentText"
            rows="3"
            required
          ></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="submit" class="btn btn-primary">Submit Comment</button>
      </div>
    </form>
  </div>
</div>

<!-- Notification Bar -->
<div
  id="hub-notification-bar"
  style="
    display: none;
    position: fixed;
    top: 24px;
    left: 50%;
    transform: translateX(-50%);
    min-width: 280px;
    max-width: 90vw;
    z-index: 9999;
    background: #198754;
    color: #fff;
    padding: 14px 32px;
    border-radius: 8px;
    font-size: 1.1rem;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.12);
    opacity: 0;
    transition: opacity 0.4s, top 0.4s;
  "
></div>

<!-- Bootstrap Icons CDN (for button icons) -->
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
/>

<script>
  let spreadsheetData = [];

  // Render cards with fade-in
  function renderCards(data) {
    const container = document.querySelector(".card-container");
    container.innerHTML = "";
    data.forEach((app, index) => {
      const card = document.createElement("div");
      card.className = "col-md-4 mb-3";
      card.innerHTML = `
        <div class="card h-100 shadow-sm border-0" data-index="${index}">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title fw-semibold">${app.name}</h5>
            <p class="card-text flex-grow-1">${app.description}</p>
            <a href="${app.link}" class="btn btn-outline-primary w-100 mt-auto mb-2" target="_blank">
              <span class="me-1"><i class="bi bi-box-arrow-up-right"></i></span>Open Link
            </a>
            <button class="btn btn-outline-secondary w-100 select-card-btn" data-index="${index}">
              <i class="bi bi-check-circle"></i> Select
            </button>
            <button class="btn btn-outline-info w-100 mt-2 comment-card-btn" data-index="${index}" data-card-id="${app.name}">
              <i class="bi bi-chat-dots"></i> Comment
            </button>
          </div>
        </div>
      `;
      container.appendChild(card);
    });

    // Add select event listeners
    document.querySelectorAll(".select-card-btn").forEach((btn) => {
      btn.onclick = function () {
        const cardDiv = btn.closest(".card.h-100");
        const index = parseInt(btn.getAttribute("data-index"));
        // If already selected, unselect
        if (window.selectedCardIndex === index) {
          cardDiv.classList.remove("border-primary", "shadow");
          window.selectedCardIndex = undefined;
        } else {
          document
            .querySelectorAll(".card.h-100")
            .forEach((c) => c.classList.remove("border-primary", "shadow"));
          cardDiv.classList.add("border-primary", "shadow");
          window.selectedCardIndex = index;
        }
      };
    });

    addCommentButtonListeners();
    container.style.opacity = 1;
    document.getElementById("loading-spinner").style.display = "none";
  }

  function addCommentButtonListeners() {
    document.querySelectorAll(".comment-card-btn").forEach((btn) => {
      btn.onclick = function () {
        const cardId = btn.getAttribute("data-card-id");
        document.getElementById("commentCardId").value = cardId;
        document.getElementById("commentForm").reset();
        commentModal.show();
      };
    });
  }

  // Add this helper function
  function addOrUpdateCard(app, index) {
    const container = document.querySelector(".card-container");
    let colDiv = container.querySelector(
      `.col-md-4.mb-3[data-index="${index}"]`
    );
    const cardHTML = `
      <div class="card h-100 shadow-sm border-0" data-index="${index}">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title fw-semibold">${app.name}</h5>
          <p class="card-text flex-grow-1">${app.description}</p>
          <a href="${app.link}" class="btn btn-outline-primary w-100 mt-auto mb-2" target="_blank">
            <span class="me-1"><i class="bi bi-box-arrow-up-right"></i></span>Open Link
          </a>
          <button class="btn btn-outline-secondary w-100 select-card-btn" data-index="${index}">
            <i class="bi bi-check-circle"></i> Select
          </button>
          <button class="btn btn-outline-info w-100 mt-2 comment-card-btn" data-index="${index}" data-card-id="${app.name}">
            <i class="bi bi-chat-dots"></i> Comment
          </button>
        </div>
      </div>
    `;
    if (colDiv) {
      colDiv.innerHTML = cardHTML; // Only update, do not add new for edit
    } else if (index === spreadsheetData.length - 1) {
      // Only add new card if it's a new entry (add mode)
      colDiv = document.createElement("div");
      colDiv.className = "col-md-4 mb-3";
      colDiv.setAttribute("data-index", index);
      colDiv.innerHTML = cardHTML;
      container.appendChild(colDiv);
    }
  }

  // Bootstrap modal instance
  let appModal = null;
  let deleteConfirmModal = null;
  let commentModal = null;
  let pendingDeleteIndex = null;

  document.addEventListener("DOMContentLoaded", function () {
    appModal = new bootstrap.Modal(document.getElementById("appModal"));
    deleteConfirmModal = new bootstrap.Modal(
      document.getElementById("deleteConfirmModal")
    );
    commentModal = new bootstrap.Modal(document.getElementById("commentModal"));

    // Add Button
    document
      .querySelector('.btn-success[title="Add"]')
      .addEventListener("click", function () {
        document.getElementById("appModalLabel").textContent = "Add Web App";
        document.getElementById("appForm").reset();
        document.getElementById("editIndex").value = "";
        appModal.show();
      });

    // Edit Button
    document
      .querySelector('.btn-warning[title="Edit"]')
      .addEventListener("click", function () {
        const index = window.selectedCardIndex;
        if (index === undefined) {
          showHubNotification("Please select a card to edit.", "#ffc107");
          return;
        }
        const app = spreadsheetData[index];
        document.getElementById("appModalLabel").textContent = "Edit Web App";
        document.getElementById("appName").value = app.name;
        document.getElementById("appLink").value = app.link;
        document.getElementById("appDescription").value = app.description;
        document.getElementById("editIndex").value = index;
        appModal.show();
      });

    // Delete Button
    document
      .querySelector('.btn-danger[title="Delete"]')
      .addEventListener("click", function () {
        const index = window.selectedCardIndex;
        if (index === undefined) {
          showHubNotification("Please select a card to delete.", "#dc3545");
          return;
        }
        pendingDeleteIndex = index;
        deleteConfirmModal.show();
      });

    // Confirm Delete in Modal
    document.getElementById("confirmDeleteBtn").onclick = function () {
      if (pendingDeleteIndex !== null) {
        google.script.run
          .withSuccessHandler(function () {
            showHubNotification("Web App deleted successfully!");
            // Remove from spreadsheetData
            spreadsheetData.splice(pendingDeleteIndex, 1);
            // Re-render all cards to update DOM and event listeners
            renderCards(spreadsheetData);
            window.selectedCardIndex = undefined;
          })
          .deleteWebAppFromSheet(pendingDeleteIndex);
        pendingDeleteIndex = null;
        deleteConfirmModal.hide();
      }
    };

    // Refresh Button
    document
      .querySelector('.btn-info[title="Refresh"]')
      .addEventListener("click", function () {
        loadWebApps();
      });

    // Handle form submit for Add/Edit
    document.getElementById("appForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const name = document.getElementById("appName").value.trim();
      const link = document.getElementById("appLink").value.trim();
      const description = document
        .getElementById("appDescription")
        .value.trim();
      const editIndex = document.getElementById("editIndex").value;
      const preview = document.getElementById("photoPreview");
      let photo =
        preview.src && preview.style.display !== "none" ? preview.src : "";

      // Fix: Proper duplicate check
      const duplicate = spreadsheetData.some(
        (app, idx) =>
          (editIndex === "" || idx != Number(editIndex)) &&
          (app.name.trim().toLowerCase() === name.toLowerCase() ||
            app.link.trim() === link)
      );

      if (duplicate) {
        showHubNotification("Name or Link is already registered!", "#dc3545");
        return;
      }

      if (editIndex === "") {
        // Add mode
        google.script.run
          .withSuccessHandler(function (data) {
            showHubNotification("Added successfully!");
            spreadsheetData.push(data);
            renderCards(spreadsheetData); // Re-render all cards and re-attach listeners
          })
          .addWebAppToSheet(name, link, description, photo);
      } else {
        // Edit mode
        google.script.run
          .withSuccessHandler(function () {
            // Update local data
            spreadsheetData[editIndex] = { name, link, description, photo };
            renderCards(spreadsheetData); // Re-render all cards and update event listeners
            window.selectedCardIndex = undefined;
            showHubNotification("Updated successfully!");
          })
          .editWebAppInSheet(editIndex, name, link, description, photo);
      }
      appModal.hide();
    });

    // Load web apps from spreadsheet
    function loadWebApps() {
      document.querySelector(".card-container").style.opacity = 0;
      document.getElementById("loading-spinner").style.display = "flex";
      google.script.run
        .withSuccessHandler(function (data) {
          spreadsheetData = data;
          renderCards(spreadsheetData);
        })
        .withFailureHandler(function (err) {
          showHubNotification("Failed to load data: " + err.message, "#dc3545");
          document.getElementById("loading-spinner").style.display = "none";
        })
        .getWebAppsFromSheet();
    }

    // Load web apps from spreadsheet
    loadWebApps(); // Only call this ONCE here!
  });

  // Place this outside DOMContentLoaded so it can access commentModal
  document
    .getElementById("commentForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();
      const name = document.getElementById("commentName").value.trim();
      const comment = document.getElementById("commentText").value.trim();
      const cardId = document.getElementById("commentCardId").value;

      if (!name || !comment) {
        showHubNotification("Please enter your name and comment.", "#dc3545");
        return;
      }

      // Close the modal immediately
      commentModal.hide();
      google.script.run
        .withSuccessHandler(function () {
          showHubNotification("Comment submitted!");
        })
        .withFailureHandler(function (err) {
          showHubNotification(
            "Failed to submit comment: " + err.message,
            "#dc3545"
          );
        })
        .addCommentToSheet(name, comment, cardId);
    });

  // Handle photo preview in modal
  document.getElementById("appPhoto").addEventListener("change", function (e) {
    const file = e.target.files[0];
    const preview = document.getElementById("photoPreview");
    if (file) {
      const reader = new FileReader();
      reader.onload = function (evt) {
        preview.src = evt.target.result;
        preview.style.display = "block";
      };
      reader.readAsDataURL(file);
    } else {
      preview.src = "";
      preview.style.display = "none";
    }
  });

  // Smooth notification function
  function showHubNotification(message, color = "#198754") {
    const bar = document.getElementById("hub-notification-bar");
    bar.textContent = message;
    bar.style.background = color;
    bar.style.display = "block";
    bar.style.opacity = 0;
    bar.style.top = "24px";
    setTimeout(() => {
      bar.style.opacity = 1;
      bar.style.top = "40px";
    }, 10);
    setTimeout(() => {
      bar.style.opacity = 0;
      bar.style.top = "24px";
      setTimeout(() => {
        bar.style.display = "none";
      }, 400);
    }, 2500); // Notification visible for 2.5 seconds
  }

  // Alternative approach using Imgur API for image hosting
  function uploadToImgur(base64Image) {
    return new Promise((resolve, reject) => {
      // Remove the "data:image/jpeg;base64," part
      const base64Data = base64Image.split(",")[1];

      fetch("https://api.imgur.com/3/image", {
        method: "POST",
        headers: {
          Authorization: "Client-ID YOUR_IMGUR_CLIENT_ID", // Replace with your Client ID
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          image: base64Data,
          type: "base64",
        }),
      })
        .then((response) => response.json())
        .then((result) => {
          if (result.success) {
            resolve(result.data.link);
          } else {
            reject(new Error("Imgur upload failed: " + result.message));
          }
        })
        .catch((error) =>
          reject(new Error("Imgur upload error: " + error.message))
        );
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    // Apply futuristic styling to buttons
    const openLinkBtns = document.querySelectorAll(".btn-outline-primary");
    const selectBtns = document.querySelectorAll(".btn-outline-secondary");
    const commentBtns = document.querySelectorAll(".btn-outline-info");

    openLinkBtns.forEach((btn) => {
      btn.classList.add("btn-futuristic", "btn-link-futuristic");
      btn.innerHTML = `<i class="bi bi-box-arrow-up-right"></i> Open Link`;
    });

    selectBtns.forEach((btn) => {
      btn.classList.add("btn-futuristic", "btn-select-futuristic");
      btn.innerHTML = `<i class="bi bi-check-circle"></i> Select`;

      // Handle selection visual feedback
      btn.addEventListener("click", function () {
        const wasSelected = this.classList.contains("selected");
        document.querySelectorAll(".select-card-btn").forEach((b) => {
          b.classList.remove("selected");
        });
        if (!wasSelected) {
          this.classList.add("selected");
        }
      });
    });

    commentBtns.forEach((btn) => {
      btn.classList.add("btn-futuristic", "btn-comment-futuristic");
      btn.innerHTML = `<i class="bi bi-chat-dots"></i> Comment`;
    });

    // Add ripple effect to all buttons
    document.querySelectorAll(".btn-futuristic").forEach((button) => {
      button.addEventListener("click", function (e) {
        let ripple = document.createElement("span");
        ripple.classList.add("ripple");
        this.appendChild(ripple);

        // Position the ripple
        let x = e.clientX - this.getBoundingClientRect().left;
        let y = e.clientY - this.getBoundingClientRect().top;

        ripple.style.left = x + "px";
        ripple.style.top = y + "px";

        setTimeout(() => {
          ripple.remove();
        }, 600);
      });
    });
  });
</script>
