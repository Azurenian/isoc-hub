<!--
  web-hub.html
  Purpose: Hub section container for the ISOC Hub application.
-->

<div id="hub-section" class="section active">
  <div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="fw-bold mb-0 hub-title">
        International Service Operations Center Hub
      </h3>
      <div class="btn-group" role="group" aria-label="Hub Controls">
        <button
          class="btn btn-success d-flex align-items-center me-2 shadow-sm"
          title="Add"
        >
          <span class="me-1 fs-5"><i class="bi bi-plus-circle"></i></span>
          <span>Add</span>
        </button>
        <button
          class="btn btn-warning d-flex align-items-center me-2 shadow-sm text-dark"
          title="Edit"
        >
          <span class="me-1 fs-5"><i class="bi bi-pencil-square"></i></span>
          <span>Edit</span>
        </button>
        <button
          class="btn btn-danger d-flex align-items-center me-2 shadow-sm"
          title="Delete"
        >
          <span class="me-1 fs-5"><i class="bi bi-trash"></i></span>
          <span>Delete</span>
        </button>
        <button
          class="btn btn-info d-flex align-items-center shadow-sm text-white"
          title="Refresh"
        >
          <span class="me-1 fs-5"><i class="bi bi-arrow-clockwise"></i></span>
          <span>Refresh</span>
        </button>
      </div>
    </div>
    <!-- Loading Spinner -->
    <div
      id="loading-spinner"
      style="
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100px;
      "
    >
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <!-- Cards Container -->
    <div class="container">
      <div
        class="row card-container"
        style="opacity: 0; transition: opacity 0.5s"
      ></div>
    </div>
  </div>
</div>

<!-- Modal for Add/Edit -->
<div
  class="modal fade"
  id="appModal"
  tabindex="-1"
  aria-labelledby="appModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <form id="appForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="appModalLabel">Add Web App</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editIndex" />
        <div class="mb-3">
          <label for="appName" class="form-label">Web App Name</label>
          <input type="text" class="form-control" id="appName" required />
        </div>
        <div class="mb-3">
          <label for="appLink" class="form-label">Link</label>
          <input type="url" class="form-control" id="appLink" required />
        </div>
        <div class="mb-3">
          <label for="appDescription" class="form-label">Description</label>
          <textarea
            class="form-control"
            id="appDescription"
            rows="3"
            required
          ></textarea>
        </div>
        <!-- Upload Photo Field -->
        <div class="mb-3">
          <label for="appPhoto" class="form-label">Upload Photo</label>
          <input type="file" class="form-control" id="appPhoto" accept="image/*" />
          <div class="mt-2 text-center">
            <img id="photoPreview" src="" alt="Preview" style="max-width: 120px; max-height: 120px; display: none; border-radius: 50%; object-fit: cover; border: 2px solid #e5e7eb;" />
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>
<style>
  #appModal:not(.show) {
    display: none;
  }
</style>

<!-- Delete Confirmation Modal -->
<div
  class="modal fade"
  id="deleteConfirmModal"
  tabindex="-1"
  aria-labelledby="deleteConfirmLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteConfirmLabel">Confirm Deletion</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this card? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          No
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
          Yes, Delete
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Comment Modal -->
<div
  class="modal fade"
  id="commentModal"
  tabindex="-1"
  aria-labelledby="commentModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <form id="commentForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="commentModalLabel">Add Comment</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="commentCardId" />
        <div class="mb-3">
          <label for="commentName" class="form-label">Your Name</label>
          <input type="text" class="form-control" id="commentName" required />
        </div>
        <div class="mb-3">
          <label for="commentText" class="form-label">Comment</label>
          <textarea
            class="form-control"
            id="commentText"
            rows="3"
            required
          ></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="submit" class="btn btn-primary">Submit Comment</button>
      </div>
    </form>
  </div>
</div>

<!-- Notification Bar -->
<div
  id="hub-notification-bar"
  style="
    display: none;
    position: fixed;
    top: 24px;
    left: 50%;
    transform: translateX(-50%);
    min-width: 280px;
    max-width: 90vw;
    z-index: 9999;
    background: #198754;
    color: #fff;
    padding: 14px 32px;
    border-radius: 8px;
    font-size: 1.1rem;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.12);
    opacity: 0;
    transition: opacity 0.4s, top 0.4s;
  "
></div>

<!-- Bootstrap Icons CDN (for button icons) -->
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
/>

<script>
  let spreadsheetData = [];

  // Render cards with fade-in
  function renderCards(data) {
    const container = document.querySelector(".card-container");
    container.innerHTML = "";
    data.forEach((app, index) => {
      const card = document.createElement("div");
      card.className = "col-md-4 mb-3";
      card.innerHTML = `
        <div class="card h-100 shadow-sm border-0" data-index="${index}">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title fw-semibold">${app.name}</h5>
            <p class="card-text flex-grow-1">${app.description}</p>
            <a href="${app.link}" class="btn btn-outline-primary w-100 mt-auto mb-2" target="_blank">
              <span class="me-1"><i class="bi bi-box-arrow-up-right"></i></span>Open Link
            </a>
            <button class="btn btn-outline-secondary w-100 select-card-btn" data-index="${index}">
              <i class="bi bi-check-circle"></i> Select
            </button>
            <button class="btn btn-outline-info w-100 mt-2 comment-card-btn" data-index="${index}" data-card-id="${app.name}">
              <i class="bi bi-chat-dots"></i> Comment
            </button>
          </div>
        </div>
      `;
      container.appendChild(card);
    });

    // Add select event listeners
    document.querySelectorAll(".select-card-btn").forEach((btn) => {
      btn.onclick = function () {
        const cardDiv = btn.closest(".card.h-100");
        const index = parseInt(btn.getAttribute("data-index"));
        // If already selected, unselect
        if (window.selectedCardIndex === index) {
          cardDiv.classList.remove("border-primary", "shadow");
          window.selectedCardIndex = undefined;
        } else {
          document
            .querySelectorAll(".card.h-100")
            .forEach((c) => c.classList.remove("border-primary", "shadow"));
          cardDiv.classList.add("border-primary", "shadow");
          window.selectedCardIndex = index;
        }
      };
    });

    addCommentButtonListeners();
    container.style.opacity = 1;
    document.getElementById("loading-spinner").style.display = "none";
  }

  function addCommentButtonListeners() {
    document.querySelectorAll(".comment-card-btn").forEach((btn) => {
      btn.onclick = function () {
        const cardId = btn.getAttribute("data-card-id");
        document.getElementById("commentCardId").value = cardId;
        document.getElementById("commentForm").reset();
        commentModal.show();
      };
    });
  }

  // Bootstrap modal instance
  let appModal = null;
  let deleteConfirmModal = null;
  let commentModal = null;
  let pendingDeleteIndex = null;

  document.addEventListener("DOMContentLoaded", function () {
    appModal = new bootstrap.Modal(document.getElementById("appModal"));
    deleteConfirmModal = new bootstrap.Modal(
      document.getElementById("deleteConfirmModal")
    );
    commentModal = new bootstrap.Modal(document.getElementById("commentModal"));

    // Add Button
    document
      .querySelector('.btn-success[title="Add"]')
      .addEventListener("click", function () {
        document.getElementById("appModalLabel").textContent = "Add Web App";
        document.getElementById("appForm").reset();
        document.getElementById("editIndex").value = "";
        appModal.show();
      });

    // Edit Button
    document
      .querySelector('.btn-warning[title="Edit"]')
      .addEventListener("click", function () {
        const index = window.selectedCardIndex;
        if (index === undefined) {
          showHubNotification("Please select a card to edit.", "#ffc107");
          return;
        }
        const app = spreadsheetData[index];
        document.getElementById("appModalLabel").textContent = "Edit Web App";
        document.getElementById("appName").value = app.name;
        document.getElementById("appLink").value = app.link;
        document.getElementById("appDescription").value = app.description;
        document.getElementById("editIndex").value = index;
        appModal.show();
      });

    // Delete Button
    document
      .querySelector('.btn-danger[title="Delete"]')
      .addEvenstListener("click", function () {
        const index = window.selectedCardIndex;
        if (index === undefined) {
          showHubNotification("Please select a card to delete.", "#dc3545");
          return;
        }
        pendingDeleteIndex = index;
        deleteConfirmModal.show();
      });

    // Confirm Delete in Modal
    document.getElementById("confirmDeleteBtn").onclick = function () {
      if (pendingDeleteIndex !== null) {
        google.script.run
          .withSuccessHandler(function () {
            showHubNotification("Web App deleted successfully!");
            loadWebApps();
            window.selectedCardIndex = undefined;
          })
          .deleteWebAppFromSheet(pendingDeleteIndex);
        pendingDeleteIndex = null;
        deleteConfirmModal.hide();
      }
    };

    // Refresh Button
    document
      .querySelector('.btn-info[title="Refresh"]')
      .addEventListener("click", function () {
        loadWebApps();
      });

    // Handle form submit for Add/Edit
    document.getElementById("appForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const name = document.getElementById("appName").value.trim();
      const link = document.getElementById("appLink").value.trim();
      const description = document.getElementById("appDescription").value.trim();
      const editIndex = document.getElementById("editIndex").value;
      const preview = document.getElementById("photoPreview");
      let photo = preview.src && preview.style.display !== "none" ? preview.src : "";

      // Check for duplicate name or link (case-insensitive)
      const duplicate = spreadsheetData.some(
        (app, idx) =>
          (editIndex === "" || idx != editIndex) &&
          (app.name.trim().toLowerCase() === name.toLowerCase() ||
            app.link.trim() === link)
      );

      if (duplicate) {
        showHubNotification("Name or Link is already registered!", "#dc3545");
        return;
      }

      if (editIndex === "") {
        // Add mode: send data to spreadsheet
        google.script.run
          .withSuccessHandler(function () {
            showHubNotification("Added successfully!");
            loadWebApps();
          })
          .addWebAppToSheet(name, link, description); // remove photo
      } else {
        // Edit mode: update spreadsheet
        google.script.run
          .withSuccessHandler(function () {
            showHubNotification("Updated successfully!");
            loadWebApps();
            window.selectedCardIndex = undefined;
          })
          .editWebAppInSheet(editIndex, name, link, description); // remove photo
      }
      appModal.hide();
    });

    // Load web apps from spreadsheet
    function loadWebApps() {
      // Hide cards, show spinner
      document.querySelector(".card-container").style.opacity = 0;
      document.getElementById("loading-spinner").style.display = "flex";
      google.script.run
        .withSuccessHandler(function (data) {
          spreadsheetData = data;
          renderCards(spreadsheetData);
        })
        .getWebAppsFromSheet();
    }

    loadWebApps(); // Initial load
    // Call this on page load and after adding/editing/deleting
    loadWebApps();
  });

  // Place this outside DOMContentLoaded so it can access commentModal
  document
    .getElementById("commentForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();
      const name = document.getElementById("commentName").value.trim();
      const comment = document.getElementById("commentText").value.trim();
      const cardId = document.getElementById("commentCardId").value;

      if (!name || !comment) {
        showHubNotification("Please enter your name and comment.", "#dc3545");
        return;
      }

      // Close the modal immediately
      commentModal.hide();
      google.script.run
        .withSuccessHandler(function () {
          showHubNotification("Comment submitted!");
        })
        .withFailureHandler(function (err) {
          showHubNotification(
            "Failed to submit comment: " + err.message,
            "#dc3545"
          );
        })
        .addCommentToSheet(name, comment, cardId);
    });

  // Handle photo preview in modal
  document.getElementById("appPhoto").addEventListener("change", function (e) {
    const file = e.target.files[0];
    const preview = document.getElementById("photoPreview");
    if (file) {
      const reader = new FileReader();
      reader.onload = function (evt) {
        preview.src = evt.target.result;
        preview.style.display = "block";
      };
      reader.readAsDataURL(file);
    } else {
      preview.src = "";
      preview.style.display = "none";
    }
  });

  // Smooth notification function
  function showHubNotification(message, color = "#198754") {
    const bar = document.getElementById("hub-notification-bar");
    bar.textContent = message;
    bar.style.background = color;
    bar.style.display = "block";
    bar.style.opacity = 0;
    bar.style.top = "24px";
    setTimeout(() => {
      bar.style.opacity = 1;
      bar.style.top = "40px";
    }, 10);
    setTimeout(() => {
      bar.style.opacity = 0;
      bar.style.top = "24px";
      setTimeout(() => {
        bar.style.display = "none";
      }, 400);
    }, 2500); // Notification visible for 2.5 seconds
  }

  // Alternative approach using Imgur API for image hosting
  function uploadToImgur(base64Image) {
    return new Promise((resolve, reject) => {
      // Remove the "data:image/jpeg;base64," part
      const base64Data = base64Image.split(',')[1];
      
      fetch('https://api.imgur.com/3/image', {
        method: 'POST',
        headers: {
          'Authorization': 'Client-ID YOUR_IMGUR_CLIENT_ID', // Replace with your Client ID
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          image: base64Data,
          type: 'base64'
        })
      })
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          resolve(result.data.link);
        } else {
          reject(new Error('Failed to upload image'));
        }
      })
      .catch(error => reject(error));
    });
  }

  // Then modify your form submit handler to use this function
  // Instead of storing base64 data directly
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
